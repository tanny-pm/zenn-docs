---
title: "ã€SwitchBotã€‘é›¨ãŒé™ã‚Šãã†ãªã¨ãã«å»Šä¸‹ãƒ©ã‚¤ãƒˆã®è‰²ã‚’å¤‰ãˆã¦ãŠçŸ¥ã‚‰ã›ã™ã‚‹æ©Ÿèƒ½ã‚’ä½œã‚‹"
emoji: "â˜”ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "switchbot"
  - "python"
  - "github actions"
published: true
---

# ã‚„ã£ãŸã“ã¨

ã€Œåˆå¾Œã‹ã‚‰é›¨äºˆå ±ãªã®ã«ã€å¤©æ°—äºˆå ±ã‚’è¦‹é€ƒã—ã¦ã„ã¦ã€å®¶ã‚’å‡ºã‚‹æ™‚ã«å‚˜ã‚’æŒã£ã¦è¡Œãã®ã‚’å¿˜ã‚Œã¦ã—ã¾ã£ãŸï¼ã€

ãã‚“ãªçµŒé¨“ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿï¼ˆç§ã¯ã‚ˆãã‚ã‚Šã¾ã™ã€‚æœã«æ™´ã‚Œã¦ã„ã‚‹æ™‚ã«ã‚ˆãã‚„ã‚Šã¾ã™ ğŸ˜‡ï¼‰ã¨ã„ã†ã‚ã‘ã§ä»Šå›ã¯ã€é›¨ã®äºˆå ±ã‚’çµ¶å¯¾ã«è¦‹é€ƒã•ãªã„ã‚ˆã†ã«ã€åˆå¾Œã®é™æ°´ç¢ºç‡ã«å¿œã˜ã¦å»Šä¸‹ã®ãƒ©ã‚¤ãƒˆã®è‰²ã‚’å¤‰ãˆã‚‹æ©Ÿèƒ½ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚ã•ã™ãŒã«ãƒ©ã‚¤ãƒˆã®è‰²ãŒé•ãˆã°æ°—ã¥ãã¯ãšï¼

ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã¯ [SwichBot ã®ãƒ©ã‚¤ãƒˆ](https://amzn.to/3Iod0MO)ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚API çµŒç”±ã§è‰²ã‚’åˆ¶å¾¡å¯èƒ½ã§ã€ãã‚Œã§ã„ã¦ä»–ç¤¾è£½ã®ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã‚ˆã‚Šå€¤æ®µãŒå®‰ã„ã®ã§ãŠã™ã™ã‚ã§ã™ã€‚

## å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

ä»¥ä¸‹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚ˆã†ã«ã€é™æ°´ç¢ºç‡ãŒé«˜ããªã‚‹ã«ã¤ã‚Œã¦ãƒ©ã‚¤ãƒˆãŒé’ããªã£ã¦ã„ãã¾ã™ã€‚ã“ã‚Œã‚’æ¯æœï¼—æ™‚ã«å®šæœŸå®Ÿè¡Œã—ã€ãã®æ™‚ç‚¹ã§ã®åˆå¾Œã®é™æ°´ç¢ºç‡ã‚’å–å¾—ã—ã¦ãƒ©ã‚¤ãƒˆã‚’ç‚¹ç¯ã•ã›ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c7e3fad359dc-20230106.jpeg)

# å®Ÿè£…ã®æµã‚Œ

ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã§å®Ÿè£…ã—ã¾ã™ã€‚ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®åˆæœŸç™»éŒ²ã¯å®Œäº†æ¸ˆã¿ã¨ã—ã¾ã™ã€‚

1. SwitchBot ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®åˆæœŸç™»éŒ²ã‚’è¡Œã†ï¼ˆèª¬æ˜çœç•¥ï¼‰
2. å¤©æ°—äºˆå ± API ã‚’åˆ©ç”¨ã—ã¦é™æ°´ç¢ºç‡ã‚’å–å¾—ã™ã‚‹
3. SwitchBot API ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ Pyhton ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè£…ã™ã‚‹
4. é™æ°´ç¢ºç‡ã«å¿œã˜ã¦ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®è‰²ã‚’å¤‰æ›´ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹
5. ä½œæˆã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ Github Actions ã§å®šæœŸçš„ã«å®Ÿè¡Œã™ã‚‹

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã® Github ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã‚‚ç¢ºèªã§ãã¾ã™ã€‚
https://github.com/tanny-pm/switchbot-rainylight

---

# é™æ°´ç¢ºç‡ã‚’å–å¾—ã™ã‚‹

ã¯ã˜ã‚ã«ã€æŒ‡å®šã—ãŸåœ°ç‚¹ã®é™æ°´ç¢ºç‡ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ä»Šå›ã¯[å¤©æ°—äºˆå ± APIï¼ˆlivedoor å¤©æ°—äº’æ›ï¼‰](https://weather.tsukumijima.net)ã‚’åˆ©ç”¨ã—ã¦é™æ°´ç¢ºç‡ã‚’å–å¾—ã—ã¾ã—ãŸã€‚èªè¨¼ãŒä¸è¦ãªãŸã‚ã€éå¸¸ã«ä½¿ã„ã‚„ã™ã„ã§ã™ã€‚

API ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹å‡¦ç†ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
https://creepfablic.site/2021/11/14/python-weather-api/#index_id1

å®Ÿè£…ã—ãŸé–¢æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`CITY_CODE`ã¯[ã“ã¡ã‚‰](https://weather.tsukumijima.net/primary_area.xml)ã®ä¸€è¦§è¡¨ã‹ã‚‰è‡ªå®…ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚
`chanceOfRain`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰ 6 æ™‚é–“ã”ã¨ã®é™æ°´ç¢ºç‡ãŒå–å¾—ã§ãã‚‹ãŸã‚ã€ä»Šå›ã¯ 12 æ™‚~24 æ™‚ã®é™æ°´ç¢ºç‡ã®ã†ã¡ã€å¤§ãã„å€¤ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```py:rainylight.py
DEVICE_ID = os.environ["SWITCHBOT_DEVICE_ID"]
WEATHER_URL = "https://weather.tsukumijima.net/api/forecast/city"

# ä¸­ç•¥

def get_pm_rainy_percent(city_code: str = CITY_CODE) -> int:
    """æŒ‡å®šã—ãŸåœ°ç‚¹ã®é™æ°´ç¢ºç‡ã‚’å–å¾—ã™ã‚‹"""

    try:
        url = f"{WEATHER_URL}/{city_code}"
        r = requests.get(url)
        # status 2xxä»¥å¤–ã¯ä¾‹å¤–ã¨ã™ã‚‹
        r.raise_for_status()
    except requests.exceptions.RequestException as e:
        logger.error(e)
    else:
        weather_json = r.json()
        logger.info(weather_json["forecasts"][0]["chanceOfRain"])  # 0:ä»Šæ—¥ 1:æ˜æ—¥ 2:æ˜å¾Œæ—¥

        rain = weather_json["forecasts"][0]["chanceOfRain"]
        rain_12 = int(re.sub("\\D", "", rain["T12_18"]) or 0)
        rain_18 = int(re.sub("\\D", "", rain["T18_24"]) or 0)

    return max(rain_12, rain_18)
```

ã“ã“ã§å–å¾—ã—ãŸé™æ°´ç¢ºç‡ã«åŸºã¥ã„ã¦ã€ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®è‰²ã‚’å¤‰åŒ–ã•ã›ã¾ã™ã€‚

# SwitchBot ã®ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹

SwitchBot API ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦ã€è‡ªåˆ†ã®ãƒ‡ãƒã‚¤ã‚¹ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
ã¾ãšã¯ä»¥ä¸‹ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ã€ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆã®å–å¾—ã‚’è¡Œã„ã¾ã™ã€‚ã“ã“ã§å–å¾—ã—ãŸãƒ‡ãƒã‚¤ã‚¹ ID ã‚’ã‚ã¨ã§åˆ©ç”¨ã—ã¾ã™ã€‚
https://github.com/OpenWonderLabs/SwitchBotAPI

:::message
API èªè¨¼ã‚­ãƒ¼ã®ä½œæˆæ–¹æ³•ãŒ v1.0 ã¨ v1.1 ã§ç•°ãªã‚Šã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ v1.1 ã®æ–¹æ³•ã§èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚
:::

## èªè¨¼ã‚­ãƒ¼ã®å–å¾—ã¨ç”Ÿæˆ

ã¾ãšã€SwitchBot ã®ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªã‹ã‚‰ API ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªæ‰‹é †ã§å–å¾—ã§ãã¾ã™ã€‚

1. ã€Œãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ã‚¿ãƒ– > ã€Œè¨­å®šã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
2. ã€Œã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€æ¬„ã‚’ 10 å›ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€Œé–‹ç™ºè€…å‘ã‘ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹
3. ã€Œé–‹ç™ºè€…å‘ã‘ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã‚’é–‹ã„ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹

ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰èªè¨¼æƒ…å ±ã‚’ç”Ÿæˆã—ã¾ã™ã€‚[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/OpenWonderLabs/SwitchBotAPI#how-to-sign)ã« Python3 ã§ã®ç”Ÿæˆæ–¹æ³•ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚å†åˆ©ç”¨ã—ã‚„ã™ã„ã‚ˆã†ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªé–¢æ•°ã¨ã—ã¦å®Ÿè£…ã—ã¦ãŠãã¾ã—ãŸã€‚

```py:get_devide_list.py
def generate_sign(token: str, secret: str, nonce: str = "") -> tuple[str, str, str]:
    """SWITCH BOT APIã®èªè¨¼ã‚­ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹"""

    t = int(round(time.time() * 1000))
    string_to_sign = "{}{}{}".format(token, t, nonce)
    string_to_sign = bytes(string_to_sign, "utf-8")
    secret = bytes(secret, "utf-8")
    sign = base64.b64encode(
        hmac.new(secret, msg=string_to_sign, digestmod=hashlib.sha256).digest()
    )

    return (str(t), str(sign, "utf-8"), nonce)
```

## ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆã®å–å¾—

ã¤ãã«ã€ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ä»¥ä¸‹ã® API ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ã¨ã€è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç™»éŒ²ã—ã¦ã„ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã®ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã™ã€‚

`https://api.switch-bot.com/v1.1/devices`

ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã®å–å¾—ã¯æœ€åˆã« 1 å›ã ã‘å®Ÿè¡Œã™ã‚Œã°è‰¯ã„ã®ã§ã€å˜ç‹¬ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å®Ÿè£…ã—ã¾ã—ãŸã€‚

```py:get_devide_list.py
API_BASE_URL = "https://api.switch-bot.com"
ACCESS_TOKEN: str = os.environ["SWITCHBOT_ACCESS_TOKEN"]
SECRET: str = os.environ["SWITCHBOT_SECRET"]

# ä¸­ç•¥

def get_device_list() -> str:
    """SWITCH BOTã®ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹"""

    t, sign, nonce = generate_sign(ACCESS_TOKEN, SECRET)
    headers = {
        "Authorization": ACCESS_TOKEN,
        "t": t,
        "sign": sign,
        "nonce": nonce,
    }
    url = f"{API_BASE_URL}/v1.1/devices"
    r = requests.get(url, headers=headers)

    return json.dumps(r.json(), indent=2, ensure_ascii=False)
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€JSON å½¢å¼ã§ãƒ‡ãƒã‚¤ã‚¹ã®ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã™ã€‚ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®`deviceId`ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚

```json
{
  "statusCode": 100,
  "body": {
    "deviceList": [
      {
        "deviceId": "xxxxxxxx",
        "deviceName": "ãƒ‡ãƒã‚¤ã‚¹å",
        "deviceType": "Color Bulb",
        "enableCloudService": true,
        "hubDeviceId": "000000000000"
      },
# çœç•¥
    ]
  },
  "message": "success"
}
```

# SwitchBot ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹

ãƒ‡ãƒã‚¤ã‚¹ã® ID ãŒå–å¾—ã§ããŸã®ã§ã€æŒ‡å®šã—ãŸã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®è‰²ã‚’å¤‰æ›´ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## ãƒ‡ãƒã‚¤ã‚¹åˆ¶å¾¡ã‚³ãƒãƒ³ãƒ‰ã®é€ä¿¡

ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®è‰²ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã€1)æ˜ã‚‹ã•ã‚’è¨­å®šã™ã‚‹ã€2)è‰²ã‚’è¨­å®šã™ã‚‹ã€3)ãƒ©ã‚¤ãƒˆã‚’ ON ã«ã™ã‚‹ã€ã¨ã„ã† 3 ã¤ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ã¾ãšã¯ãƒ‡ãƒã‚¤ã‚¹ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ãŠãã¾ã™ã€‚

ä»¥ä¸‹ã® API ã‚’ POST ã™ã‚‹ã“ã¨ã§ãƒ‡ãƒã‚¤ã‚¹ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã§ãã¾ã™ã€‚

`https://api.switch-bot.com/v1.1/devices/{device_id}/commands`

Body ã«ã¯`commandType`ã€`Command`ã€`command parameter`ã® 3 ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã™ã€‚ï¼ˆAPI ä»•æ§˜ã®è©³ç´°ã¯[ã“ã¡ã‚‰](https://github.com/OpenWonderLabs/SwitchBotAPI#color-bulb-2)ï¼‰

æ±ç”¨çš„ã«ä½¿ã„ã¾ã‚ã›ã‚‹ã‚ˆã†ã«ã€ä¸Šè¨˜ 3 ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¼•æ•°ã«æŒã¤é–¢æ•°ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚`ACCESS_TOKEN`ã¨`SECRET`ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚

```py:rainylight.py
def post_command(
    device_id: str,
    command: str,
    parameter: str = "default",
    command_type: str = "command",
):
    """æŒ‡å®šã—ãŸãƒ‡ãƒã‚¤ã‚¹ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹"""

    t, sign, nonce = generate_sign(ACCESS_TOKEN, SECRET)
    headers = {
        "Content-Type": "application/json; charset: utf8",
        "Authorization": ACCESS_TOKEN,
        "t": t,
        "sign": sign,
        "nonce": nonce,
    }
    url = f"{API_BASE_URL}/v1.1/devices/{device_id}/commands"
    body = {"command": command, "parameter": parameter, "commandType": command_type}
    data = json.dumps(body)

    try:
        logger.info(data)
        r = requests.post(url, data=data, headers=headers)
        logger.info(r.text)

    except requests.exceptions.RequestException as e:
        logger.error(e)

    return r
```

ã“ã“ã§ã€`post_command(device_id, "setColor", "255:0:0")`ã®ã‚ˆã†ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆãŒèµ¤è‰²ã«å¤‰åŒ–ã—ã¾ã™ã€‚

## ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®è‰²ã®å¤‰æ›´

å…ˆã»ã©å®Ÿè£…ã—ãŸ`post_command()`é–¢æ•°ã‚’åˆ©ç”¨ã—ã¦ã€ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®è‰²ã®å¤‰æ›´ã‚’è¡Œã„ã¾ã™ã€‚è‰²ã‚’å¤‰æ›´ã—ã¦ç‚¹ç¯ã™ã‚‹ãŸã‚ã«ã¯ã€`setBrightness`ã€`setColor`ã€`turnOn`ã®é †ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¾ã™ã€‚

ã¡ãªã¿ã«ã€ãƒ©ã‚¤ãƒˆãŒæ¶ˆç¯ã—ãŸçŠ¶æ…‹ã§`turnOn`ã®ã‚³ãƒãƒ³ãƒ‰ã ã‘ã‚’é€ä¿¡ã—ãŸå ´åˆã¯ã€æ˜ã‚‹ã•ã¨è‰²ã¯å‰å›ã®çŠ¶æ…‹ã§ç‚¹ç¯ã™ã‚‹ã‚ˆã†ã§ã™ã€‚å‰å›ã®æ˜ã‚‹ã•ã«ä¾å­˜ã›ãšã«ãƒ©ã‚¤ãƒˆã‚’ç‚¹ç¯ã™ã‚‹ãŸã‚ã«ã€`setBrightness`ã®ã‚³ãƒãƒ³ãƒ‰ã‚‚é€ä¿¡ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

3 ã¤ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®`turn_on_light()`é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚æ˜ã‚‹ã•ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ 100 ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```py:rainylight.py
def turn_on_light(
    device_id: str,
    color: tuple[int, int, int] = (0, 0, 0),
    brightness: int = 100,
):
    """æŒ‡å®šã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã§ã‚«ãƒ©ãƒ¼ãƒ©ã‚¤ãƒˆã‚’ã‚ªãƒ³ã«ã™ã‚‹"""

    (r, g, b) = color

    post_command(device_id, "setBrightness", str(brightness))
    post_command(device_id, "setColor", f"{r}:{g}:{b}")
    post_command(device_id, "turnOn")
```

æœ€å¾Œã«ã€é™æ°´ç¢ºç‡ã«åŸºã¥ã„ã¦ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®è‰²ã‚’å¤‰æ›´ã™ã‚‹ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ä»Šå›ã¯ã€é™æ°´ç¢ºç‡ 20%åˆ»ã¿ã§è‰²ãŒå¤‰åŒ–ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚0%ã®æ™‚ã¯é»„è‰²ãç‚¹ç¯ã—ã€100%ã«è¿‘ã¥ãã«ã¤ã‚Œã¦é’ãç‚¹ç¯ã—ã¾ã™ã€‚

```py:rainylight.py
def main():
    """é™æ°´ç¢ºç‡ã«åŸºã¥ã„ã¦ã‚«ãƒ©ãƒ¼ãƒ©ã‚¤ãƒˆã®è‰²ã‚’å¤‰æ›´ã™ã‚‹"""

    rain = get_pm_rainy_percent()
    logger.info(rain)

    if rain == 0:
        turn_on_light(DEVICE_ID, (255, 127, 0))
    elif rain <= 20:
        turn_on_light(DEVICE_ID, (255, 255, 0))
    elif rain <= 40:
        turn_on_light(DEVICE_ID, (127, 255, 0))
    elif rain <= 60:
        turn_on_light(DEVICE_ID, (0, 255, 255))
    elif rain <= 80:
        turn_on_light(DEVICE_ID, (0, 127, 255))
    else:
        turn_on_light(DEVICE_ID, (0, 0, 255))

    return True

if __name__ == "__main__":
    main()
```

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€å½“æ—¥åˆå¾Œã®é™æ°´ç¢ºç‡ã«åŸºã¥ã„ã¦ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã®è‰²ãŒå¤‰åŒ–ã—ã¾ã™ã€‚ï¼ˆåˆå‰ä¸­ã«ã ã‘å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚ï¼‰

# Github Actions ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ¯æœå®Ÿè¡Œã™ã‚‹

æœ€å¾Œã«ã€å®Œæˆã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ¯æœå®Ÿè¡Œã—ã€æœå‡ºã‹ã‘ã‚‹å‰ã«é™æ°´ç¢ºç‡ã‚’ãƒã‚§ãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ä»Šå›ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ Github ä¸Šã§ç®¡ç†ã—ã¦ã„ã‚‹ã®ã§ã€Github Actions ã§å®šæœŸå®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸã€‚ãƒªãƒã‚¸ãƒˆãƒªä¸Šã« YML ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨˜è¼‰ã™ã‚‹ã ã‘ã§å®šæœŸå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã€ã¨ã¦ã‚‚ãŠæ‰‹è»½ã§ã™ã€‚

ä½œæˆã—ãŸ YML ãƒ•ã‚¡ã‚¤ãƒ«ã®å…¨æ–‡ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

:::details cron.yml å…¨æ–‡

```yml:cron.yml
name: run_script
on:
  push:
  schedule:
    - cron: "0 22 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Set up Python 3.9
        uses: actions/setup-python@v1
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run script
        env:
          SWITCHBOT_ACCESS_TOKEN: ${{ secrets.SWITCHBOT_ACCESS_TOKEN }}
          SWITCHBOT_SECRET: ${{ secrets.SWITCHBOT_SECRET }}
          SWITCHBOT_DEVICE_ID: ${{ secrets.SWITCHBOT_DEVICE_ID }}
          WEATHER_CITY_CODE: ${{ secrets.WEATHER_CITY_CODE }}
        run: |
          python -m rainylight

```

:::

## å®šæœŸå®Ÿè¡Œã®è¨­å®š

`.github/workflows`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã« YML ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€å®šæœŸå®Ÿè¡Œã®è¨­å®šã‚’è¨˜è¼‰ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ã€cron ã‚³ãƒãƒ³ãƒ‰ã®è¨­å®šã®è¦é ˜ã§å®Ÿè¡Œæ™‚é–“ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚ä»Šå›ã¯æ¯æ—¥ 7 æ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸã€‚ï¼ˆè¨­å®šã¯ UTC æ™‚åˆ»ã§è¨˜è¼‰ã™ã‚‹ãŸã‚ 22 æ™‚ã¨ãªã‚Šã¾ã™ï¼‰

```yml:cron.yml
on:
  push:
  schedule:
    - cron: "0 22 * * *"
```

å‹•ä½œç¢ºèªã®ãŸã‚ã«ã€PUSH ã—ãŸæ™‚ã«ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè¡Œ

æ¬¡ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè¡Œå‡¦ç†ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã¯ SwitchBot ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚„ãƒ‡ãƒã‚¤ã‚¹ ID ãªã©ã‚’ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã‚‰ã®æƒ…å ±ã¯ Github ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰å‘¼ã³å‡ºã—ã¦ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¾ã™ã€‚

:::message
ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰ã—ã¦ã€Python ã®`dotenv`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚
:::

```yml:cron.yml
      - name: Run script
        env:
          SWITCHBOT_ACCESS_TOKEN: ${{ secrets.SWITCHBOT_ACCESS_TOKEN }}
          SWITCHBOT_SECRET: ${{ secrets.SWITCHBOT_SECRET }}
          SWITCHBOT_DEVICE_ID: ${{ secrets.SWITCHBOT_DEVICE_ID }}
          WEATHER_CITY_CODE: ${{ secrets.WEATHER_CITY_CODE }}
        run: |
          python -m rainylight
```

ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®åˆ©ç”¨æ–¹æ³•ã¯ä»¥ä¸‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

https://docs.github.com/ja/actions/security-guides/encrypted-secrets

å®Œæˆã—ãŸ YML ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Github ã« PUSH ã™ã‚‹ã¨ã€æ¯æœ 7 æ™‚ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ã“ã‚Œã§å‡ºã‹ã‘ã‚‹ã¨ãã«å‚˜ã‚’æŒã£ã¦è¡Œãã®ã‚’å¿˜ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã›ã‚“ ğŸ™Œ

# ãŠã‚ã‚Šã«

SwitchBot API ã¯å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚å……å®Ÿã—ã¦ã„ã‚‹ã®ã§ã€æ€ã£ãŸã‚ˆã‚Šç°¡å˜ã«ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸï¼ã‚¹ãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒˆã‚’ä½•ã‹ã®é€šçŸ¥ã«ä½¿ã†ã®ã¯çµæ§‹ä¾¿åˆ©ãªã®ã§ã€ä»–ã«ã‚‚é€šçŸ¥ã—ãŸã„å†…å®¹ã‚’æ€ã„ã¤ã„ãŸã‚‰å®Ÿè£…ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸä»Šå›ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®šæœŸå®Ÿè¡Œã®æ–¹æ³•ã¨ã—ã¦ Github Actions ã‚’é¸æŠã—ã¾ã—ãŸã€‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ Gihtub ä¸Šã§ç®¡ç†ã—ã¦ã„ã‚‹å ´åˆã€åˆ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãªãå®šæœŸå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã€éå¸¸ã«ãŠæ‰‹è»½ã§ã—ãŸã€‚

---

# å‚è€ƒæ–‡çŒ®

https://zenn.dev/hosaka313/articles/2c58b586927f79

https://dev.classmethod.jp/articles/switchbot-control-by-api/

https://qiita.com/cardene/items/67d31f13d27865a12ecf
