---
title: "ã€ãƒã‚¤ãƒ‘ãƒ¼ãƒ¢ãƒ€ãƒ³Pythonã€ã§ç´¹ä»‹ã•ã‚Œã¦ã„ãŸpytestã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è©¦ã—ã¦ã¿ã‚‹"
emoji: "ğŸ”Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python", "pytest", "uv" ]
published: true
---



2024å¹´9æœˆã«å‡ºç‰ˆã•ã‚ŒãŸæŠ€è¡“æ›¸ã€ãƒã‚¤ãƒ‘ãƒ¼ãƒ¢ãƒ€ãƒ³Pythonâ€•ä¿¡é ¼æ€§ã®é«˜ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹ãƒ¢ãƒ€ãƒ³ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã€ã§ã¯ã€Pythonã®ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹pytestã®åˆ©ç”¨æ–¹æ³•ã«åŠ ãˆã¦ã€pytestã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚å¤šæ•°ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://amzn.to/4j5BGcH

ã“ã®è¨˜äº‹ã§ã¯ã€ã“ã‚Œã‚‰ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æ©Ÿèƒ½æ¦‚è¦ã¨å®Ÿéš›ã«å°å…¥ã—ã¦ã¿ãŸä¾‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

ãªãŠpytestã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«é–¢ã™ã‚‹åŸºæœ¬çš„ãªèª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®è©³ç´°ã¯æ›¸ç±å†…ã®ã€Œ6ç« ï¼špytestã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆã€å†…ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã®ã§ã€ãã¡ã‚‰ã‚‚åˆã‚ã›ã¦ã”å‚ç…§ãã ã•ã„ã€‚

# ç´¹ä»‹ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä¸€è¦§
ä»¥ä¸‹ã«ã€ä»Šå›ç´¹ä»‹ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®åç§°ã¨ãã®æ¦‚è¦ã‚’ã¾ã¨ã‚ã¾ã™ã€‚PyPIã¸ã®ãƒªãƒ³ã‚¯ã‚‚æ²è¼‰ã—ã¾ã™ã®ã§ã€ã‚ˆã‚Šæ­£ç¢ºãªæƒ…å ±ã¯å„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

| ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å | æ¦‚è¦ |
|-------------|------|
| [pytest-xdist](https://pypi.org/project/pytest-xdist/) | ãƒ†ã‚¹ãƒˆã®ä¸¦åˆ—å®Ÿè¡Œã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ãƒ†ã‚¹ãƒˆã®é€Ÿåº¦å‘ä¸Šã‚’å›³ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚ |
| [pytest-cov](https://pypi.org/project/pytest-cov/) | ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šã‚’è¡Œã„ã€ãƒ†ã‚¹ãƒˆãŒã©ã‚Œã ã‘ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒãƒ¼ã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã§ãã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚ |
| [xdoctest](https://pypi.org/project/xdoctest/) | docstringã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚ |
| [pytest-sugar](https://pypi.org/project/pytest-sugar/) | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚ |
| [pytest-icdiff](https://pypi.org/project/pytest-icdiff/) | ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã«è¾æ›¸ã‚„ãƒªã‚¹ãƒˆãªã©ã®å·®åˆ†ã‚’è¡¨ç¤ºã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚ |
| [pytest-httpserver](https://pypi.org/project/pytest-httpserver/) | HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚å¤–éƒ¨APIã¨ã®é€£æºãƒ†ã‚¹ãƒˆã‚’åŠ¹ç‡çš„ã«è¡Œãˆã‚‹ã€‚ |
| [pytest-factoryboy](https://pypi.org/project/pytest-factoryboy/) | Fakerã‚„FactoryBoyã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç°¡å˜ã«ç”Ÿæˆã§ãã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚ |
| [pytest-datadir](https://pypi.org/project/pytest-datadir/) | ãƒ†ã‚¹ãƒˆç”¨ã®å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆtxtã‚„csvãªã©ï¼‰ã‚’èª­ã¿è¾¼ã¿ã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚„ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ã‚’å®Ÿè¡Œã§ãã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚ |

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯GitHubã«æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚
https://github.com/tanny-pm/pytest-plugin-demo

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã«ã¯uvã‚’æ´»ç”¨ã—ã¦ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å°å…¥ãªã©ã‚’è¡Œã„ã¾ã—ãŸã€‚`pyproject.toml`ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```toml:pyproject.toml
[project]
name = "todo_app"
version = "0.1.0"
dependencies = [
    "requests",  
]

[tool.uv]
dev-dependencies = [
    "pytest",
    "pytest-xdist",
    "pytest-sugar",
    "pytest-icdiff",
    "pytest-httpserver",
    "pytest-factoryboy",
    "pytest-datadir",
    "pytest-cov",
    "xdoctest",
    "pygments",
]

[tool.coverage.run]
source = ["pytest_plugin_demo", "tests"]
omit = ["*/__init__.py"]

[tool.coverage.report]
show_missing = true
```

ã‚½ãƒ¼ã‚¹ãƒ„ãƒªãƒ¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã«ã—ã¦ã„ã¾ã™ã€‚`todo_service.py`ãŒãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨ãªã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
```
.
â”œâ”€â”€ README.md
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ pytest_plugin_demo
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ todo_service.py
â”œâ”€â”€ tests
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py
â”‚   â”œâ”€â”€ data
â”‚   â”‚   â””â”€â”€ test_tasks.csv
â”‚   â””â”€â”€ test_todo_service.py
â””â”€â”€ uv.lock
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›´ä¸‹ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€pytestã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚ï¼ˆä¸€éƒ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€å¾Œè¿°ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚ä»˜ä¸ã—ã¾ã™ï¼‰
```
$ uv sync
$ uv run pytest
```


# ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
æ¬¡ã«ã€pytestã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã£ãŸã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ç¤ºã—ã¾ã™ã€‚TODOãƒªã‚¹ãƒˆç®¡ç†ã‚¢ãƒ—ãƒªã‚’é¡Œæã«ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’çµ„ã¿åˆã‚ã›ãŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
TODOãƒªã‚¹ãƒˆã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ã™`Task`ã‚¯ãƒ©ã‚¹ã¨ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚€`load_tasks_from_csv()`é–¢æ•°ã‚’å®Ÿè£…ã—ã€ã“ã‚Œã‚‰ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚`xdoctest`ã‚’æ´»ç”¨ã™ã‚‹ãŸã‚ã«docstringã‚‚è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚
```py:src/todo_service.py
import csv
from typing import List


class Task:
    """ã‚¿ã‚¹ã‚¯ã‚’è¡¨ã™ã‚¯ãƒ©ã‚¹ã€‚

    Attributes:
        task (str): ã‚¿ã‚¹ã‚¯ã®åå‰
        completed (bool): ã‚¿ã‚¹ã‚¯ã®å®Œäº†çŠ¶æ…‹

    Example:
        >>> task = Task("Example Task")
        >>> task.completed
        False
        >>> task.complete()
        >>> task.completed
        True
    """

    def __init__(self, task: str, completed: bool = False):
        self.task = task
        self.completed = completed

    def complete(self):
        self.completed = True


def load_tasks_from_csv(filepath: str) -> List[Task]:
    """CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚€ã€‚

    Example:
        >>> tasks = load_tasks_from_csv("tests/data/test_tasks.csv")
        >>> len(tasks)
        2
    """
    with open(filepath, newline="") as csvfile:
        reader = csv.DictReader(csvfile)
        return [Task(row["task"], row["completed"] == "True") for row in reader]

```

## ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
æ¬¡ã«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚`pytest-icdiff`ã¯ãƒ†ã‚¹ãƒˆã®**å¤±æ•—æ™‚**ã«åŠ¹æœã‚’ç™ºæ®ã™ã‚‹ãƒ†ã‚¹ãƒˆã®ãŸã‚ã€ã‚ã–ã¨å¤±æ•—ã•ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ãã‚Œãã‚Œã®ãƒ†ã‚¹ãƒˆã®è©³ç´°ã¯å¾Œè¿°ã—ã¾ã™ã€‚

```py:tests/test_todo_service.py
from src.pytest_plugin_demo.todo_service import Task, load_tasks_from_csv
from tests.conftest import TaskFactory


# pytest-httpserver ç”¨ã®ãƒ†ã‚¹ãƒˆ
def test_httpserver(httpserver):
    test_response = [{"task": "API Task", "completed": False}]
    httpserver.expect_request("/tasks").respond_with_json(test_response)

    import requests

    response = requests.get(httpserver.url_for("/tasks")).json()
    assert response[0]["task"] == "API Task"


# pytest-factoryboy ç”¨ã®ãƒ†ã‚¹ãƒˆ
def test_task_factory():
    for _ in range(100000):  # æ™‚é–“ã®ã‹ã‹ã‚‹ãƒ†ã‚¹ãƒˆ
        task = TaskFactory()
        assert isinstance(task, Task)
        assert isinstance(task.completed, bool)


def test_task_factory_2():
    for _ in range(100000):  # æ™‚é–“ã®ã‹ã‹ã‚‹ãƒ†ã‚¹ãƒˆï¼ˆä¸¦åˆ—å®Ÿè¡Œç”¨ï¼‰
        task = TaskFactory()
        assert isinstance(task, Task)
        assert isinstance(task.completed, bool)


# pytest-datadir ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½¿ç”¨
def test_load_tasks_from_csv(shared_datadir):
    csv_file = shared_datadir / "test_tasks.csv"
    tasks = load_tasks_from_csv(str(csv_file))
    assert len(tasks) == 2


# pytest-icdiff å·®åˆ†æ¯”è¼ƒ
def test_task_comparison():
    task1 = Task("Task A")
    task2 = Task("Task B")
    assert task1.__dict__ == task2.__dict__  # æ•…æ„ã«å¤±æ•—ã•ã›ã‚‹
```

---

ã“ã“ã‹ã‚‰ã¯ã€pytestã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’3ã¤ã®ç¨®é¡ã«åˆ†ã‘ã¦ç´¹ä»‹ã—ã¾ã™ã€‚


# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•ã«é–¢é€£ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

## pytest-xdist
pytest-xdistã¯ã€ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚ã“ã‚Œã‚’æ´»ç”¨ã™ã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œé€Ÿåº¦ã‚’å‘ä¸Šã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ã€-n auto ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œã—ã¾ã™ã€‚

```py:tests/test_todo_service.py
pytest -n auto
```

ä»Šå›ã¯ã€ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚é–“ãŒé•·ããªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ã„ã¾ã™ã€‚ã“ã®çŠ¶æ…‹ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã‚’æ¯”è¼ƒã—ã¦ã¿ã¾ã™ã€‚

```py:tests/test_todo_service.pyï¼ˆä¸€éƒ¨ï¼‰

# pytest-factoryboy ç”¨ã®ãƒ†ã‚¹ãƒˆ
def test_task_factory():
    for _ in range(100000):  # æ™‚é–“ã®ã‹ã‹ã‚‹ãƒ†ã‚¹ãƒˆ
        task = TaskFactory()
        assert isinstance(task, Task)
        assert isinstance(task.completed, bool)


def test_task_factory_2():
    for _ in range(100000):  # æ™‚é–“ã®ã‹ã‹ã‚‹ãƒ†ã‚¹ãƒˆï¼ˆä¸¦åˆ—å®Ÿè¡Œç”¨ï¼‰
        task = TaskFactory()
        assert isinstance(task, Task)
        assert isinstance(task.completed, bool)
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€åŠæ¸›ã¨ã¾ã§ã¯ã„ãã¾ã›ã‚“ãŒã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚é–“ã‚’å‰Šæ¸›ã§ãã¾ã—ãŸï¼ˆ4.68secâ†’3.22secï¼‰ã€‚ã‚‚ã£ã¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒå¤šã„å ´åˆã¯ã•ã‚‰ã«åŠ¹æœãŒè¦‹è¾¼ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
```
$ uv run pytest  # é€šå¸¸å®Ÿè¡Œ
ï¼ˆç•¥ï¼‰
Results (4.68s):
       4 passed
       1 failed
         - tests/test_todo_service.py:39 test_task_comparison

# uv run pytest -n auto  # ä¸¦åˆ—å®Ÿè¡Œ
ï¼ˆç•¥ï¼‰
Results (3.22s):
       4 passed
       1 failed
         - tests/test_todo_service.py:39 test_task_comparison
```

ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚é–“ãŒé•·ããªã£ã¦ããŸæ™‚ã«ã¯å°å…¥ã‚’æ¤œè¨ã—ãŸã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚

## pytest-cov
pytest-cov ã¯ã€ã‚³ãƒ¼ãƒ‰ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ¸¬å®šã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚ãƒ†ã‚¹ãƒˆãŒã‚«ãƒãƒ¼ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã®å‰²åˆã‚’ãƒ¬ãƒãƒ¼ãƒˆã¨ã—ã¦è¡¨ç¤ºã—ã¦ãã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```py:tests/test_todo_service.py
pytest --cov
```

ä»Šå›ã¯ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ100%ã«ãªã‚Šã¾ã—ãŸã€‚ï¼ˆpyproject.tomlã®è¨­å®šã§ã€``__init__.py``ã‚’è¨ˆæ¸¬å¯¾è±¡å¤–ã«ã—ã¦ã„ã¾ã™ï¼‰

```sh
---------- coverage: platform darwin, python 3.12.2-final-0 ----------
Name                         Stmts   Miss  Cover   Missing
----------------------------------------------------------
tests/conftest.py                7      0   100%
tests/test_todo_service.py      26      0   100%
----------------------------------------------------------
TOTAL                           33      0   100%
```

ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€å†…éƒ¨çš„ã«ã¯`Coverage.py`ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚è©³ç´°ãªè¨­å®šæ–¹æ³•ãªã©ã¯ãã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã™ã‚‹ã¨ã‚ˆã•ãã†ã§ã™ã€‚

## xdoctest
xdoctest ã¯ã€docstringã«è¨˜è¼‰ã—ãŸExampleã®å†…å®¹ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚å˜ä½“ã§ã‚‚åˆ©ç”¨ã§ãã¾ã™ãŒã€`--xdoctest`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€pytestã®ãƒ†ã‚¹ãƒˆã¨åŒæ™‚ã«å®Ÿè¡Œã§ãã¾ã™ã€‚

```sh
$ uv run pytest --xdoctest 
```

å®Ÿè¡Œçµæœã‚’è¦‹ã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ä¸­ã«docstringã®ãƒ†ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ï¼ˆãƒ‘ã‚¹ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°ãŒ4ã‹ã‚‰6ã«å¢—åŠ ï¼‰
```sh
src/pytest_plugin_demo/todo_service.py âœ“âœ“   
ï¼ˆç•¥ï¼‰
Results (4.68s):
       6 passed
       1 failed
         - tests/test_todo_service.py:39 test_task_comparison
```

ã“ã“ã¾ã§ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã™ã¹ã¦åŒæ™‚ã«åˆ©ç”¨ã™ã‚‹å ´åˆã€pytestã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```sh
$ uv run pytest --xdoctest --cov -n auto
```


# ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œçµæœã«é–¢é€£ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

ç¶šã„ã¦ã¯ã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œçµæœã‚’è¦‹ã‚„ã™ãã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚ã©ã‚“ãªå ´åˆã§ã‚‚æ±ç”¨çš„ã«æ´»ç”¨ã§ãã¾ã™ã€‚

## pytest-sugar
pytest-sugar ã¯ãƒ†ã‚¹ãƒˆã®é€²è¡ŒçŠ¶æ³ã‚’è¦–è¦šçš„ã«è¡¨ç¤ºã—ã€é€²è¡ŒçŠ¶æ³ãƒãƒ¼ã‚„æˆåŠŸãƒ»å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’è‰²åˆ†ã‘ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆã®çµæœãŒç›´æ„Ÿçš„ã«ã‚ã‹ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å°å…¥ã™ã‚‹ã ã‘ã§è‡ªå‹•çš„ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/05fadccd39cd-20250120.png)
_å³ä¸Šã®ã€Œ100%ã€ã®ç®‡æ‰€ãŒãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã€‚å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã¯èµ¤ã§è¡¨ç¤ºã•ã‚Œã‚‹_

ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã«æ™‚é–“ãŒã‹ã‹ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯å°å…¥ã—ã¦ãŠãã¨è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚


## pytest-icdiff
pytest-icdiff ã‚’ä½¿ã†ã¨ã€è¾æ›¸ã‚„ãƒªã‚¹ãƒˆãªã©ã®æ¯”è¼ƒæ™‚ã«ã€å·®åˆ†ã‚’è¦‹ã‚„ã™ãè¡¨ç¤ºã§ãã¾ã™ã€‚ã“ã‚Œã‚‚ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å°å…¥ã™ã‚‹ã ã‘ã§è‡ªå‹•çš„ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/6b2a51016c09-20250120.png)

å·®åˆ†ãŒå‡ºã¦ã„ã‚‹ç®‡æ‰€ã ã‘ãŒå¼·èª¿ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚é …ç›®æ•°ã®å¤šã„è¾æ›¸ã‚’æ‰±ã†å ´åˆã¯ã¨ãã«å½¹ç«‹ã¡ãã†ã§ã™ã€‚


# ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…ã«é–¢é€£ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

æœ€å¾Œã«ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…ã‚’å®¹æ˜“ã«ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚ãƒ†ã‚¹ãƒˆã™ã‚‹å†…å®¹ã«å¿œã˜ã¦å°å…¥ã—ã¾ã™ã€‚

## pytest-httpserver
pytest-httpserver ã¯ã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚å¤–éƒ¨APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹éš›ã€äº‹å‰ã«è¨­å®šã—ãŸå†…å®¹ã‚’è¿”ã™ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã®ã‚ˆã†ã«ã€å¤–éƒ¨APIã®URLã‚’æŒ‡å®šã™ã‚‹ç®‡æ‰€ã‚’ã€`httpserver`ã§ç½®ãæ›ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```py:tests/test_todo_service.py
def test_httpserver(httpserver):
    test_response = [{"task": "API Task", "completed": False}]
    httpserver.expect_request("/tasks").respond_with_json(test_response)

    import requests
    response = requests.get(httpserver.url_for("/tasks")).json()
    assert response[0]["task"] == "API Task"
```

å¤–éƒ¨APIã¨é€£æºã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹éš›ã«ã¯ç©æ¥µçš„ã«æ´»ç”¨ã—ãŸã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚


## pytest-factoryboy
pytest-factoryboy ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚

ã¾ãšã€ä»¥ä¸‹ã®ã‚ˆã†ã«`TaskFactory`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚ä»Šå›ã¯ã€ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ãª3ã¤ã®å˜èªãŒè¨­å®šã•ã‚Œã‚‹ã‚ˆã†ãªFactoryã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
```py:conftest.py
import factory

from src.pytest_plugin_demo.todo_service import Task


class TaskFactory(factory.Factory):
    class Meta:
        model = Task

    task = factory.Faker("sentence", nb_words=3)
    completed = factory.Faker("boolean")
```

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å†…ã§ã¯å…ˆã»ã©å®šç¾©ã—ãŸ`TaskFactory`ã‚¯ãƒ©ã‚¹ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ãŒè¨­å®šã•ã‚ŒãŸ`Task`ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚ãã®ã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```py:tests/test_todo_service.py
def test_task_factory():
    task = TaskFactory()
    assert isinstance(task, Task)
    assert isinstance(task.completed, bool)
```

è©¦ã—ã«`task`ã®ä¸­èº«ã‚’å‡ºåŠ›ã—ã¦ã¿ãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã—ãŸã€‚
```
task=Hot economic.       comp=True
task=Allow marriage.     comp=False
task=Over eight.         comp=True
task=Sing than light.    comp=False
task=Baby then.          comp=False
task=Response news.      comp=False
task=Wife score.         comp=False
```

## pytest-datadir
pytest-datadir ã¯ã€ãƒ†ã‚¹ãƒˆã§ä½¿ã†å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç°¡å˜ã«ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã®ã‚ˆã†ã«ã€`datadir`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€`data/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
```py:tests/test_todo_service.py
def test_load_tasks_from_csv(datadir):
    csv_file = datadir / "test_tasks.csv"
    tasks = load_tasks_from_csv(str(csv_file))
    assert len(tasks) == 2
```
ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒã‚¤ãƒ³ãƒˆã¯ã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼ã—ã¦åˆ©ç”¨ã™ã‚‹ç‚¹ã§ã™ã€‚ãã®ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å¤‰æ›´ã™ã‚‹ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã«ãŠã„ã¦åŠ¹æœã‚’ç™ºæ®ã—ã¾ã™ã€‚


# ã¾ã¨ã‚
ã“ã®è¨˜äº‹ã§ã¯ã€pytestã®ä¾¿åˆ©ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã€å®Ÿç”¨ä¾‹ã‚’äº¤ãˆã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚ãã‚Œãã‚Œã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã†ã¾ãæ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®è¨˜è¼‰ã‚’å®¹æ˜“ã«ã—ã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚‚åŠ¹ç‡åŒ–ã§ãã¾ã™ã€‚

pytestã«ã¯è±Šå¯Œãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚‹ã“ã¨ã¯çŸ¥ã£ã¦ã„ã¾ã—ãŸãŒã€å®Ÿéš›ã«ã©ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚‹ã‹ã€ä½“å‹çš„ã«ã¯æŠŠæ¡ã§ãã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ä»Šå›ã®æ¤œè¨¼ã‚’é€šã˜ã¦ã€ãã‚Œãã‚Œã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ¡ãƒªãƒƒãƒˆã‚’å®Ÿæ„Ÿã§ãã¾ã—ãŸã€‚
ã“ã®ä¸­ã§ã‚‚ã€ãƒ†ã‚¹ãƒˆçµæœã®å·®åˆ†ã‚’è¦‹ã‚„ã™ãã™ã‚‹pytest-icdiffã¯ã€ã¨ã‚Šã‚ãˆãšå°å…¥ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã—ãŸã€‚ãã®ä»–ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯å¿…è¦ã«å¿œã˜ã¦å°å…¥ã‚’æ¤œè¨ã—ãŸã„ã§ã™ã€‚

# å‚è€ƒæ–‡çŒ®
- ã€Hypermodern Python Toolingã€Claudio Jolowiczã€O'Reillyã€Copyright 2024 Claudio Jolowiczã€978-1-098-13958-2ã€é‚¦é¡Œã€ãƒã‚¤ãƒ‘ãƒ¼ãƒ¢ãƒ€ãƒ³Pythonã€ã‚ªãƒ©ã‚¤ãƒªãƒ¼ãƒ»ã‚¸ãƒ£ãƒ‘ãƒ³ã€ISBN978-4-8144-0092-8